#!/usr/bin/env node
'use strict';

var nova = require('../lib')
    , getopt = require('node-getopt')
    , AWS = require('aws-sdk')
    , novaform = require('novaform')
    , _ = require('underscore');

var opts = getopt.create([
    ['p', 'profile=ARG', 'set which aws profile to use for credentials'],
    ['r', 'region=ARG', 'set which region you want to use'],
    ['v', 'validate', 'validate stack'],
    ['l', 'list', 'list available stacks in project'],
    ['h', 'help', 'Display this help']
]).bindHelp().parseSystem();

var validate = opts.options['validate'];
var profile = opts.options['profile'];
var region = opts.options['region'];
var list = opts.options['list'];
var path = opts.argv[0];

var pathComponents = path.split('/');
var projectName = pathComponents[0];
var stackName = pathComponents[1];

var project = require(process.cwd() + '/' + projectName);

if (list) {
    console.log(_.pluck(project, 'name'));
    process.exit(0);
}

var credentials = new AWS.SharedIniFileCredentials({profile: profile});
AWS.config.credentials = credentials;
AWS.config.logger = process.stdout;
AWS.config.region = region;

var stackConfig = _.findWhere(project, {name: stackName});
console.log(stackConfig);
var stackBuild = stackConfig.build({region: region});

var stack = novaform.Stack(stackName);
_.forEach(stackBuild.resourceGroups, function(resourceGroup) {
    stack.add(resourceGroup);
});
_.forEach(stackBuild.outputs, function(output) {
    stack.add(output);
});

if (validate) {
    console.log('Using profile:', profile);
    console.log('Validating ' + stackName + ' in project ' + projectName);

    var cloudformation = new AWS.CloudFormation();

    var params = {
        TemplateBody: stack.toJson(),
    };

    cloudformation.validateTemplate(params, function(err, data) {
        if (err) {
            console.log(err, err.stack);
            return;
        }

        console.log(data);
    });
}